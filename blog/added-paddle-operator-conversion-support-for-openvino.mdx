---
authors:
- PuQing
date: 2023-08-01 21:20
keywords:
- private
- OpenVINO
- OpenSource
- PaddlePaddle
tags:
- private
- OpenVINO
- OpenSource
- PaddlePaddle
---
# ä¸º OpenVINO æ–°å¢ Paddle ç®—å­è½¬æ¢æ”¯æŒ

## ä»‹ç»

åœ¨è¿™ç¯‡æ•™ç¨‹ä¸­ï¼Œä½ å°†ä¼šä¸€æ­¥ä¸€æ­¥å­¦ä¹ å¦‚ä½•ä¸º OpenVINO æ–°å¢ Paddle ç®—å­è½¬æ¢æ”¯æŒã€‚PaddlePaddle æ˜¯æœ€å—æ¬¢è¿çš„å›½äº§æ·±åº¦å­¦ä¹ æ¡†æ¶ä¹‹ä¸€ï¼Œè™½ç„¶ OpenVINO å·²ç»æ”¯æŒäº† Paddle ç¦»çº¿æ¨¡å‹çš„è½½å…¥ä»¥åŠè½¬æ¢ä¸º IR æ ¼å¼ï¼Œä½†æ˜¯éšç€æ¡†æ¶çš„è¿­ä»£æ›´æ–°ï¼Œä¼šä¸æ–­çš„æ„å»ºæ–°çš„ç®—å­ï¼Œç”šè‡³ä¿®æ”¹éƒ¨åˆ†ç®—å­çš„ API æ¥å£ï¼Œæ‰€ä»¥éœ€è¦å¼€å‘è€…æ·»åŠ æ–°çš„ç®—å­æ˜ å°„æ”¯æŒï¼Œä»è€Œä½¿ Paddle ä»¥åŠ OpenVINO æ›´åŠ æ˜“ç”¨ã€‚

## ç¬¬ä¸€æ­¥ï¼šFork

é¦–å…ˆè‡³ [OpenVino](https://github.com/openvinotoolkit/openvino) å®˜æ–¹ä»“åº“ï¼Œç„¶åç‚¹å‡» fork æŒ‰é’®ï¼Œç”Ÿæˆè‡ªå·±ç›®å½•ä¸‹çš„ä»“åº“ï¼Œæ¯”å¦‚ <https://github.com/USERNAME/openvino>

## ç¬¬äºŒæ­¥ï¼šå…‹éš†

å°†è¿œç¨‹ä»“åº“ clone åˆ°æœ¬åœ°ï¼š


<!--truncate-->
```shell
$ git clone https://https://github.com/USERNAME/openvino
$ cd openvino
```

## ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæœ¬åœ°åˆ†æ”¯

ä¸å»ºè®®ç›´æ¥åœ¨ master åˆ†æ”¯ä¸Šç›´æ¥è¿›è¡Œå¼€å‘ï¼Œä¸€èˆ¬ä» master åˆ†æ”¯ä¸Šåˆ›å»ºæ–°åˆ†æ”¯ã€‚

```shell
$ git checkout -b BRANCHNAME
```

> BRANCHNAME å»ºè®®èµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åˆ†æ”¯åå­—

## ç¬¬å››æ­¥ï¼šå¼€å§‹æ­£å¼å¼€å‘

åœ¨æ­£å¼å¼€å‘å‰ï¼Œæˆ‘ä»¬å…ˆå°è¯•ä»æºç ç¼–è¯‘ OpenVINO

### 4.1 å°è¯•ä»æºç ç¼–è¯‘

#### 4.1.1 æ›´æ–°å­æ¨¡å—ä»“åº“æºç 

```shell
$ git submodule update --init --recursive
```

> å¦‚æœä½äºä¸­å›½åœ°åŒºæ‹‰å–ä»“åº“æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ä¸€ä¸‹è„šæœ¬è¿›è¡Œæ‹‰å–

```shell
$ cd openvino
$ chmod +x scripts/submodule_update_with_gitee.sh
$ ./scripts/submodule_update_with_gitee.sh
```

#### 4.1.2 ä¸‹è½½ã€build ä¾èµ–

```shell
$ chmod +x install_build_dependencies.sh
$ ./install_build_dependencies.sh
```

#### 4.1.3 æ„å»ºé¡¹ç›®

```shell
export OPENVINO_BASEDIR=`pwd`
$ mkdir build
$ cd build
$ cmake \
-DCMAKE_BUILD_TYPE= Release -DCMAKE_INSTALL_PREFIX="${OPENVINO_BASEDIR}/openvino_dist" \
-DPYTHON_EXECUTABLE=$(which python3) \
-DENABLE_MYRIAD=OFF \
-DENABLE_VPU=OFF \
-DENABLE_PYTHON=ON \
-DNGRAPH_PYTHON_BUILD_ENABLE=ON \
-DENABLE_DEBUG_CAPS=ON \
-DENABLE_CPU_DEBUG_CAPS=ON  \
-DENABLE_TESTS=ON \
..
```

å…³äºç¼–è¯‘çš„é€‰æ‹©é¡¹å¯ä»¥æŸ¥çœ‹ [æ­¤å¤„](https://github.com/openvinotoolkit/openvino/wiki/CMakeOptionsForCustomCompilation)ã€‚

#### 4.1.4 ç¼–è¯‘ã€å®‰è£…

```shell
$ make -j$(nproc); make install
```

ä¸Šè¿°ä¾¿å®Œæˆäº† openvino çš„ç¼–è¯‘å®‰è£…è¿‡ç¨‹ã€‚

è‹¥å®Œæˆäº†ä»¥ä¸Šæ­¥éª¤ï¼Œä¾¿å¯ä»¥ç»§ç»­ä¸‹é¢çš„æ­£å¼å¼€å‘äº†ã€‚

> æ³¨æ„ï¼šæ¯æ¬¡ä¿®æ”¹ä»£ç åéœ€è¦å†æ¬¡ç¼–è¯‘å®‰è£…

### 4.2 æ–°å¢ç®—å­è½¬æ¢ï¼ˆä»¥ gather_nd ç®—å­ä¸ºä¾‹ï¼‰

æ–°å¢ä¸€ä¸ªç®—å­çš„è½¬æ¢æˆ‘ä»¬éœ€è¦åœ¨ä¸‹åˆ—æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”æ–‡ä»¶æˆ–ä»£ç 

- åœ¨ [src/frontends/paddle/src/op/frontends/paddle/src/op](https://github.com/openvinotoolkit/openvino/tree/master/src/frontends/paddle/src/op) æ·»åŠ ç®—å­æ˜ å°„çš„å®ç°

- åœ¨ [src/frontends/paddle/src/op_table.cpp](https://github.com/openvinotoolkit/openvino/blob/master/src/frontends/paddle/src/op_table.cpp) ä¸­æ³¨å†Œè¯¥ç®—å­æ˜ å°„

- åœ¨ [src/core/tests/frontend/paddle/test_models/gen_scripts](https://github.com/openvinotoolkit/openvino/tree/master/src/core/tests/frontend/paddle/test_models/gen_scripts) æ·»åŠ è¯¥ç®—å­çš„å•æµ‹å®ä¾‹ç”Ÿæˆè„šæœ¬

- åœ¨ [src/core/tests/frontend/paddle/op_fuzzy.cpp](https://github.com/openvinotoolkit/openvino/blob/master/src/core/tests/frontend/paddle/op_fuzzy.cpp) æ³¨å†Œå•æµ‹å®ä¾‹

æœ¬æ•™ç¨‹ä¹Ÿä¼šä»¥ä¸Šé¢é¡ºåºè¿›è¡Œä»‹ç»

#### 4.2.1 ç®—å­æ˜ å°„çš„å®ç°

é¦–å…ˆåœ¨ [Paddle Docs](https://www.paddlepaddle.org.cn/documentation/docs/zh/develop/api/paddle/gather_nd_cn.html#gather-nd) æŸ¥çœ‹è¯¥ç®—å­çš„ç”¨æ³•ï¼Œå†æ ¹æ®ç®—å­æ—è¾¹çš„ [æºä»£ç ](https://github.com/PaddlePaddle/Paddle/blob/develop/python/paddle/tensor/manipulation.py#L3751) é“¾æ¥è·³è½¬è‡³è¯¥ç®—å­çš„ Python å‰ç«¯ä»£ç ï¼Œå¦‚ä¸‹å›¾ï¼š

![image.png](http://4c4g.puqing.work:8089/i/2023/08/02/64ca098a7adf9.webp)

ä¸‹é¢æ˜¯æˆªå–çš„éƒ¨åˆ†ä»£ç ï¼Œå¹¶ç®€è¦è¯´æ˜å…¶ä½œç”¨

```python
    helper = LayerHelper('gather_nd', **locals())
    dtype = helper.input_dtype()
    output = helper.create_variable_for_type_inference(dtype)
    helper.append_op(
        type="gather_nd",
        inputs={"X": x, "Index": index},
        outputs={"Out": output},
    )
    return output
```

`LayerHelper` æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»º OP è¾“å‡ºå˜é‡ã€å‘é™æ€å›¾ `program` ä¸­æ·»åŠ  OP çš„è¾…åŠ©å·¥å…·ç±»ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å®ä¾‹äº†ä¸€ä¸ª gather_nd ç®—å­ï¼Œå¹¶å°†è¾“å…¥ Tensorï¼Œè¾“å‡º Tensor, ä»¥ä¸¤ä¸ªå­—å…¸çš„å½¢å¼ï¼Œä½œä¸ºå‚æ•°æ·»åŠ  OP

æ‰€ä»¥é€šè¿‡è¿™éƒ¨åˆ†ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ Paddle è¿™è¾¹ gather_nd é€šè¿‡è¾“å…¥ inputs å­—å…¸ï¼Œå­—å…¸ä¸­æœ‰ "X" ï¼Œ"Index" å­—æ®µã€‚

> è€Œå…¶ä»–çš„ç®—å­çš„å‚æ•°å¹¶éä¹Ÿæ˜¯ Tensor è¾“å…¥çš„ï¼Œè€Œæ˜¯ä½œä¸º attributes å­—å…¸è¾“å…¥çš„ï¼Œä¾‹å¦‚ [shard_index](https://github.com/PaddlePaddle/Paddle/blob/develop/python/paddle/tensor/manipulation.py#L603) åˆ™æ˜¯ä»¥ attr å­—å…¸è¾“å…¥çš„

åŒæ—¶æŸ¥é˜… openvino çš„ [ç®—å­è¡¨](https://github.com/openvinotoolkit/openvino/blob/master/docs/ops/opset9.md) å¯ä»¥çŸ¥é“ openvino æœ‰ [GatherND](https://github.com/openvinotoolkit/openvino/blob/master/docs/ops/movement/GatherND_8.md) ç®—å­ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å°è¯•å†™å‡ºå¦‚ä¸‹è½¬æ¢ä»£ç 

```cpp
...

 NamedOutputs gather_nd(const NodeContext& node) {
     const auto data_node = node.get_input("X");
     const auto index_node = node.get_input("Index");
     return node.default_single_output_mapping({std::make_shared<default_opset::GatherND>(data_node, index_node)},
                                               {"Out"});
...

```

å…³äº NodeContext çš„è¯´æ˜å¯ä»¥æŸ¥çœ‹ [openvinoå®˜æ–¹æ–‡æ¡£å…³äºå‰ç«¯æ‹“å±•çš„éƒ¨åˆ†](https://github.com/openvinotoolkit/openvino/blob/943f77d9ecac1b82fcf6c190b74909d2523fff55/docs/Extensibility_UG/frontend_extensions.md)

#### 4.2.2 æ³¨å†Œç®—å­

åœ¨ [src/frontends/paddle/src/op_table.cpp](https://github.com/openvinotoolkit/openvino/blob/master/src/frontends/paddle/src/op_table.cpp) æ–‡ä»¶ä¸­æ³¨å†Œè¯¥ç®—å­ã€‚

```cpp
...
OP_CONVERTER(gather_nd);
...
std::map<std::string, CreatorFunction> get_supported_ops() {
    return {
 {"gather_nd", op::gather_nd},
 };
```

åŠ å…¥è‡ªå·±æ–°å¢çš„ç®—å­å³å¯

#### 4.2.3 æ–°å¢å•æµ‹

ä¸ºäº†æµ‹è¯•è‡ªå·±æ–°åŠ å…¥çš„å•æµ‹æ˜¯å¦å®Œæˆè½¬æ¢æˆ–è€…ç²¾åº¦è¦æ±‚ï¼Œéœ€è¦æ·»åŠ å•å…ƒæµ‹è¯•

å…·ä½“åœ¨ [src/core/tests/frontend/paddle/test_models/gen_scripts](https://github.com/openvinotoolkit/openvino/tree/master/src/core/tests/frontend/paddle/test_models/gen_scripts) æ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªå•æµ‹æ–‡ä»¶

ä¾‹å¦‚ï¼š`generate_gather_nd.py`

åœ¨ç¼–å†™å•å…ƒæµ‹è¯•è¿‡ç¨‹ä¸­è¯·å°½é‡å…¨é¢ï¼Œå¦‚è¾“å…¥ç±»å‹çš„å•æµ‹ï¼Œè¾“å…¥ä¸è¾“å…¥ä¹‹é—´å…³ç³»çš„å•æµ‹ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ï¼Œè¾“å…¥å€¼ä¸ºç‰¹æ®Šå€¼çš„æƒ…å†µ (ç©ºæ•°ç»„ï¼Œè´Ÿå€¼ï¼Œé›¶å€¼) ç­‰

#### 4.2.4 æ³¨å†Œå•æµ‹å®ä¾‹

åœ¨å®Œæˆå•æµ‹çš„ç¼–å†™åï¼Œéœ€è¦åœ¨ op_fuzzy.cpp ä¸­æ³¨å†Œå•æµ‹ [src/core/tests/frontend/paddle/op_fuzzy.cpp](https://github.com/openvinotoolkit/openvino/blob/master/src/core/tests/frontend/paddle/op_fuzzy.cpp)

ä¾‹å¦‚ï¼š

```cpp
std::string("gather_nd_float32"),
std::string("gather_nd_int64"),
std::string("gather_nd_int32"),
std::string("gather_nd_empty"),
std::string("gather_nd_low_index"),
std::string("gather_nd_high_rank1"),
std::string("gather_nd_high_rank2"),
```

#### 4.2.5 é‡æ–°ç¼–è¯‘ä»¥åŠè¿è¡Œå•æµ‹

```shell
$ make -j$(nproc); make install
```

```shell
$ cd bin/intel64/Release
$ ./paddle_tests --gtest_filter=PaddleFuzzyOpTest/FrontEndFuzzyOpTest.testOpFuzzy/*
```

> æ­¤å¤„çš„ * æ˜¯é€šé…ç¬¦ï¼Œè‹¥åªæƒ³æµ‹è¯•æ·»åŠ çš„ç®—å­å¯ä»¥ä¾‹å¦‚ï¼š*gather_nd* çš„å†™æ³•è¿›è¡Œæµ‹è¯•

![image.png](http://4c4g.puqing.work:8089/i/2023/08/02/64ca09f887d39.webp)

åœ¨æµ‹è¯•å®Œæ¯•åæœ‰ä¸€ä¸ªå•æµ‹å‘ç”Ÿäº†æŠ¥é”™ï¼Œæ ¹æ®æç¤ºè¯´æ˜ openvino æ˜¯ä¸æ”¯æŒ rank=0 çš„æ•°ç»„è¾“å…¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·çš„è¾“å…¥æ•°æ®è¿›è¡Œæ£€æŸ¥ã€‚

#### 4.2.6 æ˜ å°„å®ç°çš„ä¼˜åŒ–

æ ¹æ®å•ä¾§æˆ‘ä»¬éœ€è¦ä¸æ–­è¿­ä»£è‡ªå·±çš„ç®—å­æ˜ å°„çš„å®ç°ï¼Œå°±æœ¬ä¾‹å­ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹äºè¾“å…¥å¼ é‡è¿›è¡Œæ£€æŸ¥ï¼š

```cpp
...
auto shape = index_node.get_partial_shape();
if (shape.is_static() && shape.rank().get_length() == 0)
    PADDLE_OP_CHECK(node, false, "zero 'indices' input rank is not allowed for gather_nd");
...
```

è¿™é‡Œæˆ‘ä»¬å¯¹è¾“å…¥çš„ index è¿›è¡Œå½¢çŠ¶æ£€æŸ¥ï¼Œå¹¶è¿›è¡ŒæŠ¥é”™æç¤ºã€‚PADDLE_OP_CHECK æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œå½“ç¬¬äºŒä¸ªå‚æ•°æ˜¯ false æ—¶ï¼Œå°†ç¬¬ä¸‰ä¸ªè¾“å…¥ä½œä¸ºæŠ¥é”™ä¿¡æ¯ã€‚

#### 4.2.7 PR çš„æäº¤

åœ¨å®Œæˆä¸Šè¿°è¿‡ç¨‹åæˆ‘ä»¬ä¾¿å¯ä»¥å°è¯•æäº¤ä¸€ä¸ª PR å•¦ã€‚

åœ¨æäº¤ä¹‹å‰å…ˆå°†ä»£ç æäº¤å¹¶åŒæ­¥è‡³è¿œç«¯

```shell
$ git status
$ git add changfile
$ git commit -m "add a paddle op gather_op"
```

> commit ä¿¡æ¯å°½é‡æœ‰æ„ä¹‰ä¸”èƒ½è¯´æ˜æ¯æ¬¡çš„ä¿®æ”¹å†…å®¹

æ¨é€è‡³è¿œç«¯

```shell
$ git fetch upstream
$ git pull upstream BRANCHNAME
```

å¼€å¯ä¸€ä¸ª PR å¹¶å¡«å†™ title ï¼Œä¸ºäº†æ–¹ä¾¿ reviewï¼Œè¯·é™„ä¸Šè‡ªå·±å•ä¾§çš„é€šè¿‡æƒ…å†µçš„æˆªå›¾ä»¥åŠ Paddle ç®—å­å¯¹åº”ç®—å­çš„å®ç°

![1-ä¸º OpenVINO æ–°å¢ Paddle ç®—å­è½¬æ¢æ”¯æŒ.png](http://4c4g.puqing.work:8089/i/2023/08/02/64ca09df727ac.webp)

è‡³æ­¤ä¾¿å®Œæˆäº† openvino gather_nd ç®—å­å¯¹äº Paddle çš„è½¬æ¢æ”¯æŒ ğŸ‰

## æ€»ç»“

æœ¬æ–‡ç« ç®€å•ä»‹ç»äº†å¦‚ä½•å‘ OpenVINO æ–°å¢ä¸€ä¸ª Paddle ç®—å­è½¬æ¢çš„æµç¨‹ï¼Œå­¦ä¹ åˆ°äº†å¦‚ä½•åœ¨ OpenVINO ä¸­æ·»åŠ ç®—å­è½¬æ¢å®ç°ä»¥åŠæ·»åŠ å¯¹åº”çš„å•æµ‹ï¼Œæœ¬ä»»åŠ¡éš¾åº¦é€‚ä¸­ï¼Œå»ºè®®å°è¯•ã€‚ä½†æ˜¯åœ¨å®ç°æ˜ å°„çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„åœ¨ä¸åŒå°ºåº¦ï¼Œä¸åŒç»„åˆæ–¹å¼çš„è¾“å…¥ç²¾åº¦å¯¹é½çš„é—®é¢˜ï¼Œå¯ä»¥æŸ¥çœ‹ OpenVINO [ç®—å­å®ç°](https://github.com/openvinotoolkit/openvino/tree/master/src/core/reference/include/ngraph/runtime/reference)ï¼Œä»¥åŠ [Paddleç®—å­](https://github.com/PaddlePaddle/Paddle/blob/develop/python/paddle/fluid/tests/unittests/test_angle_op.py) çš„å®ç°ã€‚
